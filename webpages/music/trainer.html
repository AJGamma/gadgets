<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web å…¨èƒ½éŸ³ä¹å¬åŠ›è®­ç»ƒå™¨ (Pro V2)</title>
    <style>
        :root {
            --primary: #4a69bd;
            --secondary: #6a89cc;
            --accent: #e55039;
            --bg: #f1f2f6;
            --card: #ffffff;
            --text: #2f3542;
            --highlight: #2ed573;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            background: var(--card);
            width: 100%;
            max-width: 1000px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #dfe4ea;
            overflow-x: auto;
        }
        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            font-weight: 600;
            color: #747d8c;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            background: var(--card);
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        .tab-btn:hover:not(.active) {
            background: #ced6e0;
        }

        /* Content */
        .content {
            padding: 20px;
            display: none;
        }
        .content.active {
            display: block;
        }

        /* Sections */
        .section {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f1f2f6;
        }
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Controls */
        .grid-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 8px;
        }
        .flex-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        label {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            cursor: pointer;
            user-select: none;
        }
        input[type="checkbox"], input[type="radio"] {
            accent-color: var(--primary);
            margin-right: 6px;
        }
        select, input[type="number"] {
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Special Toggle for Sequence Mode */
        .seq-toggle {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            padding: 5px 10px;
            border-radius: 6px;
            color: #15803d;
            font-weight: bold;
        }

        /* Status Box */
        .status-box {
            background: #dfe6e9;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 10px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .main-text { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin: 5px 0; }
        .sub-text { font-size: 0.9rem; color: #636e72; }
        .seq-tag { font-size: 0.8rem; background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }

        /* Buttons */
        .action-bar {
            padding: 20px;
            background: #f7f9fa;
            border-top: 1px solid #eee;
            display: flex;
            gap: 15px;
        }
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-start { background: var(--primary); color: white; }
        .btn-start:hover { background: #3c56a5; }
        .btn-stop { background: var(--accent); color: white; }
        .btn-stop:disabled { background: #b2bec3; cursor: not-allowed; }

        /* Helpers */
        .note-selector {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        .note-check {
            border: 1px solid #ccc;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .note-check.checked {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
    </style>
</head>
<body>

<div class="container">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('interval-loop')">â‘  éŸ³ç¨‹å¾ªç¯</button>
        <button class="tab-btn" onclick="switchTab('chord-loop')">â‘¡ å’Œå¼¦å¾ªç¯</button>
        <button class="tab-btn" onclick="switchTab('interval-quiz')">â‘¢ éŸ³ç¨‹å¬è¾¨(è¯­éŸ³)</button>
        <button class="tab-btn" onclick="switchTab('chord-quiz')">â‘£ å’Œå¼¦å¬è¾¨(è¯­éŸ³)</button>
        <button class="tab-btn" onclick="switchTab('note-quiz')">â‘¤ å•éŸ³å¬è¾¨(è¯­éŸ³)</button>
    </div>

    <!-- é€šç”¨è®¾ç½®åŒºåŸŸ -->
    <div style="padding: 20px 20px 0 20px; border-bottom: 1px dashed #ccc;">
        <div class="section-title">é€šç”¨è®¾ç½®ï¼šæ ¹éŸ³è¿‡æ»¤ & èŒƒå›´</div>
        <div class="flex-row" style="margin-bottom: 10px;">
            <span>éŸ³åŸŸèŒƒå›´:</span>
            <select id="range-min" style="width:80px"></select> 
            <span>è‡³</span> 
            <select id="range-max" style="width:80px"></select>
        </div>
        <div class="flex-row">
            <span style="font-size:0.9rem;">å…è®¸çš„æ ¹éŸ³å:</span>
            <div class="note-selector" id="root-note-filter">
                <!-- JS ç”Ÿæˆ C, C#, D ... -->
            </div>
            <button onclick="toggleAllNotes()" style="font-size:0.8rem; padding:2px 8px;">å…¨é€‰/åé€‰</button>
        </div>
    </div>

    <!-- Tab 1: éŸ³ç¨‹å¾ªç¯ -->
    <div id="interval-loop" class="content active">
        <div class="section">
            <div class="section-title">é€‰æ‹©éŸ³ç¨‹ (å¤šé€‰) <button onclick="setChecks('int-list-loop', true)">å…¨é€‰</button><button onclick="toggleChecks('int-list-loop')">åé€‰</button></div>
            <div class="grid-options" id="int-list-loop"></div>
        </div>
        <div class="section">
            <div class="section-title">æ’­æ”¾è®¾ç½®</div>
            <div class="flex-row">
                <label><input type="checkbox" class="play-dir-loop" value="asc" checked> ä¸Šè¡Œ</label>
                <label><input type="checkbox" class="play-dir-loop" value="desc" checked> ä¸‹è¡Œ</label>
                <label><input type="checkbox" class="play-dir-loop" value="harm" checked> å’Œå£°</label>
            </div>
            
            <!-- æ–°å¢ï¼šé¡ºåºæ¨¡å¼å¼€å…³ -->
            <div style="margin-top:15px;">
                <label class="seq-toggle">
                    <input type="checkbox" id="seq-mode-int" checked> é”å®šéŸ³ç»„ï¼šä¾æ¬¡æ’­æ”¾æ‰€æœ‰é€‰ä¸­æ¨¡å¼ (é¡ºåºæ’­æ”¾)
                </label>
            </div>

            <div class="flex-row" style="margin-top:15px;">
                <span>é€Ÿåº¦(ms):</span> <input type="number" id="speed-loop" value="400" step="50" style="width:60px">
                <span>é—´éš”(s):</span> <input type="number" id="gap-loop" value="0.5" step="0.5" style="width:60px">
                <span>é‡å¤æ¬¡æ•°:</span> <input type="number" id="repeat-loop-int" value="1" min="1" style="width:50px">
            </div>
        </div>
    </div>

    <!-- Tab 2: å’Œå¼¦å¾ªç¯ -->
    <div id="chord-loop" class="content">
        <div class="section">
            <div class="section-title">é€‰æ‹©å’Œå¼¦ (å¤šé€‰) <button onclick="setChecks('chord-list-loop', true)">å…¨é€‰</button><button onclick="toggleChecks('chord-list-loop')">åé€‰</button></div>
            <div class="grid-options" id="chord-list-loop"></div>
        </div>
        
        <!-- æ–°å¢ï¼šè‡ªå®šä¹‰å’Œå¼¦æ·»åŠ åŒºåŸŸ -->
        <div class="section" style="background: #fdfdfd; border: 1px dashed #ccc; padding: 10px; border-radius: 6px;">
            <div class="section-title" style="font-size: 1rem;">æ·»åŠ è‡ªå®šä¹‰å’Œå¼¦</div>
             <div class="flex-row" style="align-items: flex-end;">
                <div>
                    <div style="font-size:0.8rem;color:#666;margin-bottom:4px;">åç§° (å¦‚: MyMaj9)</div>
                    <input type="text" id="new-chord-name" style="width:110px">
                </div>
                <div>
                    <div style="font-size:0.8rem;color:#666;margin-bottom:4px;">éŸ³ç¨‹ (åŠéŸ³, é€—å·åˆ†éš”)</div>
                    <input type="text" id="new-chord-int" placeholder="0,4,7,11" style="width:140px">
                </div>
                <button onclick="addCustomChord()" style="padding:6px 15px; background:var(--highlight); color:white; border:none; border-radius:4px; cursor:pointer;">æ·»åŠ </button>
            </div>
            <div style="margin-top:5px; font-size:0.8rem; color:#999;">æ³¨ï¼š0ä»£è¡¨æ ¹éŸ³ã€‚ä¾‹å¦‚å¤§ä¸‰å’Œå¼¦ä¸º 0,4,7</div>
        </div>

        <div class="section">
            <div class="section-title">æ’­æ”¾è®¾ç½®</div>
            <div class="flex-row">
                <label><input type="checkbox" class="chord-dir-loop" value="up" checked> ä¸Šè¡Œç¶éŸ³</label>
                <label><input type="checkbox" class="chord-dir-loop" value="down" checked> ä¸‹è¡Œç¶éŸ³</label>
                <label><input type="checkbox" class="chord-dir-loop" value="harmonic" checked> æŸ±å¼å’Œå¼¦</label>
            </div>

            <!-- æ–°å¢ï¼šé¡ºåºæ¨¡å¼å¼€å…³ -->
            <div style="margin-top:15px;">
                <label class="seq-toggle">
                    <input type="checkbox" id="seq-mode-chord" checked> é”å®šéŸ³ç»„ï¼šä¾æ¬¡æ’­æ”¾æ‰€æœ‰é€‰ä¸­æ¨¡å¼ (é¡ºåºæ’­æ”¾)
                </label>
            </div>

            <div class="flex-row" style="margin-top:15px;">
                <span>ç¶éŸ³é€Ÿåº¦:</span> <input type="number" id="arp-speed-loop" value="150" style="width:60px">
                <span>é—´éš”(s):</span> <input type="number" id="chord-gap-loop" value="0.5" step="0.5" style="width:60px">
                <span>é‡å¤æ¬¡æ•°:</span> <input type="number" id="repeat-loop-chord" value="1" min="1" style="width:50px">
            </div>
            
            <div class="section-title" style="margin-top:20px;">é«˜çº§ Voicing è®¾ç½®</div>
            <div class="flex-row">
                <label><input type="checkbox" id="inv-loop" checked> å…è®¸è½¬ä½</label>
                <label><input type="checkbox" id="double-loop"> å…è®¸å…«åº¦é‡å¤</label>
                <span>éŸ³æ•°ä¸Šé™: <input type="number" id="max-notes-loop" value="4" min="3" max="8" style="width:50px"></span>
            </div>
        </div>
    </div>

    <!-- Tab 3: éŸ³ç¨‹å¬è¾¨ (è¯­éŸ³) -->
    <div id="interval-quiz" class="content">
        <div class="section">
            <div class="section-title">å¬è¾¨èŒƒå›´ (24ä¸ªéŸ³ç¨‹) <button onclick="setChecks('int-list-quiz', true)">å…¨é€‰</button><button onclick="toggleChecks('int-list-quiz')">åé€‰</button></div>
            <div class="grid-options" id="int-list-quiz" style="grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));"></div>
        </div>
        <div class="section">
            <div class="section-title">æ’­æŠ¥è®¾ç½®</div>
            <div class="flex-row">
                 <label><input type="checkbox" id="speak-root-int"> æ’­æŠ¥æ ¹éŸ³ (å¦‚: "C å¤§ä¸‰åº¦")</label>
                 <span>æ’­æ”¾æ¨¡å¼:</span>
                 <select id="quiz-int-mode">
                     <option value="asc">ä»…ä¸Šè¡Œ</option>
                     <option value="desc">ä»…ä¸‹è¡Œ</option>
                     <option value="harm">ä»…å’Œå£°</option>
                     <option value="random" selected>éšæœºæ··åˆ</option>
                 </select>
            </div>
            <div class="flex-row" style="margin-top:10px;">
                <span>é—´éš”(s):</span> <input type="number" id="gap-quiz-int" value="0.5" step="0.5" style="width:60px">
                <span>æ’­æ”¾æ¬¡æ•°:</span> <input type="number" id="repeat-quiz-int" value="1" min="1" style="width:50px">
                <small style="color:#666; margin-left:10px;">(å£°éŸ³æ’­æŠ¥å®Œåçš„ç­‰å¾…æ—¶é—´)</small>
            </div>
        </div>
    </div>

    <!-- Tab 4: å’Œå¼¦å¬è¾¨ (è¯­éŸ³) -->
    <div id="chord-quiz" class="content">
        <div class="section">
            <div class="section-title">å¬è¾¨èŒƒå›´ <button onclick="setChecks('chord-list-quiz', true)">å…¨é€‰</button><button onclick="toggleChecks('chord-list-quiz')">åé€‰</button></div>
            <div class="grid-options" id="chord-list-quiz"></div>
        </div>
        <div class="section">
            <div class="section-title">æ’­æŠ¥ä¸éš¾åº¦</div>
            <div class="flex-row">
                 <label><input type="checkbox" id="speak-root-chord"> æ’­æŠ¥æ ¹éŸ³ (å¦‚: "D å°ä¸ƒ")</label>
                 <label><input type="checkbox" id="inv-quiz"> åŒ…å«è½¬ä½</label>
            </div>
            <div class="flex-row" style="margin-top:10px;">
                <span>é—´éš”(s):</span> <input type="number" id="gap-quiz-chord" value="0.5" step="0.5" style="width:60px">
                <span>æ’­æ”¾æ¬¡æ•°:</span> <input type="number" id="repeat-quiz-chord" value="1" min="1" style="width:50px">
            </div>
        </div>
    </div>

    <!-- Tab 5: å•éŸ³å¬è¾¨ (è¯­éŸ³) -->
    <div id="note-quiz" class="content">
        <div class="section">
            <div class="section-title">è¯´æ˜</div>
            <p style="margin:0; color:#666; font-size:0.9rem;">
                æ­¤æ¨¡å¼å°†éšæœºæ’­æ”¾â€œé€šç”¨è®¾ç½®â€ä¸­é€‰ä¸­çš„éŸ³ç¬¦ï¼ˆå¦‚C, D, Eç­‰ï¼‰ï¼Œå¹¶åœ¨æ’­æ”¾åè¯­éŸ³æŠ¥å‡ºéŸ³åã€‚
                <br>é€‚åˆç»å¯¹éŸ³æ„Ÿè®­ç»ƒã€‚å»ºè®®åœ¨ä¸Šæ–¹å‡å°‘é€‰ä¸­çš„æ ¹éŸ³æ•°é‡ï¼Œä»3-4ä¸ªéŸ³å¼€å§‹ç»ƒä¹ ã€‚
            </p>
        </div>8
        <div class="section">
            <div class="section-title">è®¾ç½®</div>
            <div class="flex-row">
                <span>éŸ³é•¿(ms):</span> <input type="number" id="note-dur-quiz" value="800" style="width:60px">
                <span>é—´éš”(s):</span> <input type="number" id="gap-quiz-note" value="0.5" step="0.5" style="width:60px">
                <span>æ’­æ”¾æ¬¡æ•°:</span> <input type="number" id="repeat-quiz-note" value="1" min="1" style="width:50px">
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨çŠ¶æ€ä¸æ“ä½œ -->
    <div class="status-box" id="status-display">
        <div class="main-text">å‡†å¤‡å°±ç»ª</div>
        <div class="sub-text">è¯·é€‰æ‹©æ¨¡å¼å¹¶ç‚¹å‡»å¼€å§‹</div>
    </div>

    <div class="action-bar">
        <button class="btn btn-start" id="btn-toggle">å¼€å§‹è®­ç»ƒ (Space)</button>
    </div>
</div>

<script>
    // --- å…¨å±€æ•°æ® ---
    const NOTE_NAMES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    
    // 0-24ä¸ªåŠéŸ³çš„éŸ³ç¨‹å®šä¹‰
    const INTERVALS = [
        { semitones: 1, name: "å°äºŒåº¦ (m2)" }, { semitones: 2, name: "å¤§äºŒåº¦ (M2)" },
        { semitones: 3, name: "å°ä¸‰åº¦ (m3)" }, { semitones: 4, name: "å¤§ä¸‰åº¦ (M3)" },
        { semitones: 5, name: "çº¯å››åº¦ (P4)" }, { semitones: 6, name: "ä¸‰å…¨éŸ³ (TT)" },
        { semitones: 7, name: "çº¯äº”åº¦ (P5)" }, { semitones: 8, name: "å°å…­åº¦ (m6)" },
        { semitones: 9, name: "å¤§å…­åº¦ (M6)" }, { semitones: 10, name: "å°ä¸ƒåº¦ (m7)" },
        { semitones: 11, name: "å¤§ä¸ƒåº¦ (M7)" }, { semitones: 12, name: "çº¯å…«åº¦ (P8)" },
        { semitones: 13, name: "å°ä¹åº¦ (m9)" }, { semitones: 14, name: "å¤§ä¹åº¦ (M9)" },
        { semitones: 15, name: "å°ååº¦ (m10)" }, { semitones: 16, name: "å¤§ååº¦ (M10)" },
        { semitones: 17, name: "çº¯åä¸€ (P11)" }, { semitones: 19, name: "çº¯åäºŒ (P12)" },
        { semitones: 24, name: "åäº”åº¦ (P15)" }
    ];

const DEFAULT_CHORDS = [
  { id: 'maj',      name: 'å¤§ä¸‰',                 int: [0, 4, 7] },
  { id: 'min',      name: 'å°ä¸‰',                 int: [0, 3, 7] },
  { id: 'aug',      name: 'å¢ä¸‰',             int: [0, 4, 8] },
  { id: 'dim',      name: 'å‡ä¸‰',            int: [0, 3, 6] },
  { id: 'sus4',     name: 'æŒ‚å››',         int: [0, 5, 7] },
  { id: 'maj7',     name: 'å¤§ä¸ƒ',             int: [0, 4, 7, 11] },
  { id: 'min7',     name: 'å°ä¸ƒ',             int: [0, 3, 7, 10] },
  { id: 'dom7',     name: 'å±ä¸ƒ',          int: [0, 4, 7, 10] },
  { id: 'm7b5',     name: 'åŠå‡ä¸ƒ', int: [0, 3, 6, 10] },
  { id: 'dim7',     name: 'å‡ä¸ƒ',        int: [0, 3, 6, 9] },
  { id: 'maj9',     name: 'å¤§ä¹',             int: [0, 4, 7, 11, 14] },
  { id: 'sus2',     name: 'æŒ‚äºŒ',         int: [0, 2, 7] },
  { id: 'minMaj7',  name: 'å°å¤§ä¸ƒ',     int: [0, 3, 7, 11] },
  { id: 'aug7',     name: 'å¢ä¸ƒ',         int: [0, 4, 8, 10] },
  { id: 'dom7sus4', name: 'å±ä¸ƒæŒ‚å››',    int: [0, 5, 7, 10] },
  { id: 'min9',     name: 'å°ä¹',             int: [0, 3, 7, 10, 14] },
  { id: 'dom9',     name: 'å±ä¹',          int: [0, 4, 7, 10, 14] },
  { id: 'dom9sus4', name: 'å±ä¹æŒ‚å››',    int: [0, 5, 7, 10, 14] },
  { id: 'dom13',    name: 'å±åä¸‰',       int: [0, 4, 7, 10, 14, 21] },
  { id: 'add9',     name: 'åŠ ä¹',                  int: [0, 4, 7, 14] },
  { id: '6',        name: 'å…­å’Œå¼¦',           int: [0, 4, 7, 9] },
  { id: 'dom7b9',   name: 'å±ä¸ƒé™ä¹',      int: [0, 4, 7, 10, 13] },
  { id: 'dom7#9',   name: 'å±ä¸ƒå‡ä¹',      int: [0, 4, 7, 10, 15] }
];

    // --- çŠ¶æ€å˜é‡ ---
    let customChords = []; // æ–°å¢ï¼šè‡ªå®šä¹‰å’Œå¼¦åˆ—è¡¨
    let audioCtx;
    let isPlaying = false;
    let currentTab = 'interval-loop';
    let timeoutId = null;
    let activeOscs = [];
    let masterVolume = 0.5; // å…¨å±€éŸ³é‡ (0.0 - 1.0)
    
    // è¯­éŸ³æ”¯æŒ
    let availableVoices = [];
    function loadVoices() {
        if(!window.speechSynthesis) return;
        availableVoices = window.speechSynthesis.getVoices();
    }
    if (window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = loadVoices;
        // å°è¯•ç«‹å³åŠ è½½
        loadVoices();
    }

    // **æ–°å¢ï¼šé¡ºåºæ’­æ”¾çŠ¶æ€ç®¡ç†**
    let sequenceState = {
        active: false,
        queue: [],      // å¾…æ’­æ”¾çš„æ¨¡å¼åˆ—è¡¨ ['up', 'down', 'harm']
        index: 0,       // å½“å‰æ’­æ”¾åˆ°ç¬¬å‡ ä¸ª
        data: null      // é”å®šçš„éŸ³ç¬¦æ•°æ® { root: 60, notes: [60, 64, 67], name: "C Maj" }
    };
    
    // **æ–°å¢ï¼šå¾ªç¯æ¨¡å¼é‡å¤æ’­æ”¾çŠ¶æ€**
    let loopRepeatState = {
        count: 0,
        max: 1,
        lastData: null
    };

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        initUI();
    };

    function initUI() {
        // 1. æ ¹éŸ³èŒƒå›´
        const minSel = document.getElementById('range-min');
        const maxSel = document.getElementById('range-max');
        for(let i=36; i<=96; i++) {
            let label = midiToName(i);
            minSel.add(new Option(label, i));
            maxSel.add(new Option(label, i));
        }
        minSel.value = 48; // C3
        maxSel.value = 84;

        // 2. æ ¹éŸ³éŸ³åè¿‡æ»¤ (C, C#, D...)
        const rootFilterContainer = document.getElementById('root-note-filter');
        NOTE_NAMES.forEach((name, idx) => {
            const div = document.createElement('div');
            div.className = 'note-check checked'; // é»˜è®¤å…¨é€‰
            div.innerText = name;
            div.dataset.val = idx;
            div.onclick = function() {
                this.classList.toggle('checked');
            };
            rootFilterContainer.appendChild(div);
        });

        // 3. å¡«å……éŸ³ç¨‹åˆ—è¡¨
        ['int-list-loop', 'int-list-quiz'].forEach(id => {
            const container = document.getElementById(id);
            INTERVALS.forEach(intObj => {
                const checked = intObj.semitones <= 12 ? 'checked' : '';
                const html = `<label><input type="checkbox" value="${intObj.semitones}" ${checked}> ${intObj.name}</label>`;
                container.innerHTML += html;
            });
        });

        // 4. å¡«å……å’Œå¼¦åˆ—è¡¨ (å·²ç§»è‡³ renderChordSelectors)
        renderChordSelectors();

        // ç»‘å®šæŒ‰é’®
        document.getElementById('btn-toggle').onclick = togglePlay;
        
        // ç»‘å®šç©ºæ ¼é”®
        document.addEventListener('keydown', function(e) {
            if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
                e.preventDefault(); // é˜²æ­¢æ»šåŠ¨é¡µé¢
                togglePlay();
            }
        });

        // 5. åŠ è½½ä¸Šæ¬¡ä¿å­˜çš„è®¾ç½®
        loadSettings();
        
        // 6. è‡ªåŠ¨ä¿å­˜ (é¡µé¢å…³é—­æˆ–åˆ·æ–°å‰)
        window.addEventListener('beforeunload', saveSettings);
    }

    // --- æ•°æ®æŒä¹…åŒ– (æ–°å¢) ---
    const STORAGE_KEY = 'music_trainer_v2_settings';

    function saveSettings() {
        const settings = {};

        // 1. ä¿å­˜ç®€å•çš„ Input/Select/Checkbox (é€šè¿‡ ID)
        const ids = [
            'range-min', 'range-max', 
            'speed-loop', 'gap-loop', 'seq-mode-int', 'repeat-loop-int',
            'arp-speed-loop', 'chord-gap-loop', 'seq-mode-chord', 'inv-loop', 'double-loop', 'max-notes-loop', 'repeat-loop-chord',
            'speak-root-int', 'quiz-int-mode', 'gap-quiz-int', 'repeat-quiz-int',
            'speak-root-chord', 'inv-quiz', 'gap-quiz-chord', 'repeat-quiz-chord',
            'note-dur-quiz', 'gap-quiz-note', 'repeat-quiz-note'
        ];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                settings[id] = (el.type === 'checkbox') ? el.checked : el.value;
            }
        });

        // 2. ä¿å­˜ Tab
        settings.currentTab = currentTab;

        // 3. ä¿å­˜æ ¹éŸ³è¿‡æ»¤å™¨ (Note Selector)
        const rootNotes = [];
        document.querySelectorAll('#root-note-filter .note-check').forEach(el => {
            if(el.classList.contains('checked')) {
                rootNotes.push(parseInt(el.dataset.val));
            }
        });
        settings.rootNotes = rootNotes;

        // 4.5 ä¿å­˜è‡ªå®šä¹‰å’Œå¼¦
        settings.customChords = customChords;

        // 4. ä¿å­˜å„ç§åˆ—è¡¨å¤é€‰æ¡†
        settings.intListLoop = getCheckedValues('#int-list-loop input');
        settings.playDirLoop = getCheckedValues('.play-dir-loop');
        settings.chordListLoop = getCheckedValues('#chord-list-loop input');
        settings.chordDirLoop = getCheckedValues('.chord-dir-loop');
        settings.intListQuiz = getCheckedValues('#int-list-quiz input');
        settings.chordListQuiz = getCheckedValues('#chord-list-quiz input');

        localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
    }

    function getCheckedValues(selector) {
        return Array.from(document.querySelectorAll(selector))
            .filter(el => el.checked)
            .map(el => el.value);
    }

    function loadSettings() {
        const json = localStorage.getItem(STORAGE_KEY);
        if(!json) return;
        
        let settings;
        try { settings = JSON.parse(json); } catch(e) { return; }

        // æ¢å¤ç®€å• ID
        for(let key in settings) {
            // è·³è¿‡å¤æ‚å¯¹è±¡
            if(['currentTab', 'rootNotes', 'intListLoop', 'playDirLoop', 'chordListLoop', 'chordDirLoop', 'intListQuiz', 'chordListQuiz', 'customChords'].includes(key)) continue;
            
            const el = document.getElementById(key);
            if(el) {
                if(el.type === 'checkbox') el.checked = settings[key];
                else el.value = settings[key];
            }
        }

        // 0. æ¢å¤è‡ªå®šä¹‰å’Œå¼¦ (å¿…é¡»åœ¨æ¸²æŸ“åˆ—è¡¨ä¹‹å‰)
        if(settings.customChords && Array.isArray(settings.customChords)) {
            customChords = settings.customChords;
        }
        
        // é‡æ–°æ¸²æŸ“å’Œå¼¦åˆ—è¡¨ä»¥åŒ…å«è‡ªå®šä¹‰å’Œå¼¦
        renderChordSelectors();

        // æ¢å¤ Tab
        if(settings.currentTab) {
             const tabBtn = document.querySelector(`button[onclick="switchTab('${settings.currentTab}')"]`);
             if(tabBtn) tabBtn.click();
        }

        // æ¢å¤æ ¹éŸ³
        if(settings.rootNotes && Array.isArray(settings.rootNotes)) {
            document.querySelectorAll('#root-note-filter .note-check').forEach(el => {
                const val = parseInt(el.dataset.val);
                if(settings.rootNotes.includes(val)) el.classList.add('checked');
                else el.classList.remove('checked');
            });
        }

        // æ¢å¤åˆ—è¡¨å¤é€‰æ¡†
        restoreChecks('#int-list-loop input', settings.intListLoop);
        restoreChecks('.play-dir-loop', settings.playDirLoop);
        restoreChecks('#chord-list-loop input', settings.chordListLoop);
        restoreChecks('.chord-dir-loop', settings.chordDirLoop);
        restoreChecks('#int-list-quiz input', settings.intListQuiz);
        restoreChecks('#chord-list-quiz input', settings.chordListQuiz);
    }

    function restoreChecks(selector, values) {
        if(!values || !Array.isArray(values)) return;
        document.querySelectorAll(selector).forEach(el => {
            el.checked = values.includes(el.value);
        });
    }

    function getAllChords() {
        return [...DEFAULT_CHORDS, ...customChords];
    }

    function renderChordSelectors() {
        const all = getAllChords();
        ['chord-list-loop', 'chord-list-quiz'].forEach(id => {
            const container = document.getElementById(id);
            // å¤‡ä»½å½“å‰é€‰ä¸­çŠ¶æ€
            const oldCheckedValues = Array.from(container.querySelectorAll('input:checked')).map(i => i.value);
            
            container.innerHTML = '';
            
            all.forEach(c => {
                let isChecked = false;
                if (oldCheckedValues.length > 0) {
                    isChecked = oldCheckedValues.includes(c.id);
                } else {
                    // åˆå§‹é»˜è®¤é€‰ä¸­ maj å’Œ min
                    isChecked = ['maj','min'].includes(c.id);
                }
                
                let labelHtml = `${c.name}`;
                if (c.isCustom) {
                    // è‡ªå®šä¹‰å’Œå¼¦æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                    labelHtml += ` <span style="color:red; font-weight:bold; margin-left:5px; cursor:pointer;" title="åˆ é™¤" onclick="removeCustomChord('${c.id}', event)">Ã—</span>`;
                } else {
                    labelHtml += ` (${c.id})`;
                }

                const div = document.createElement('div');
                div.innerHTML = `<label style="display:inline-flex; align-items:center; width:100%;">
                    <input type="checkbox" value="${c.id}" ${isChecked ? 'checked' : ''}> 
                    <span style="flex:1">${labelHtml}</span>
                </label>`;
                container.appendChild(div.firstElementChild);
            });
        });
    }

    function addCustomChord() {
        const nameInput = document.getElementById('new-chord-name');
        const intInput = document.getElementById('new-chord-int');
        
        const name = nameInput.value.trim();
        const intStr = intInput.value.trim();
        
        if(!name || !intStr) { alert("è¯·è¾“å…¥åç§°å’ŒéŸ³ç¨‹"); return; }
        
        // è§£æéŸ³ç¨‹
        let intervals = [];
        try {
            intervals = intStr.split(/[,ï¼Œ\s]+/).map(s => parseInt(s));
            if(intervals.some(isNaN)) throw new Error();
        } catch(e) {
            alert("éŸ³ç¨‹æ ¼å¼é”™è¯¯ï¼Œè¯·ä½¿ç”¨æ•°å­—å’Œé€—å·ï¼Œå¦‚: 0,4,7");
            return;
        }
        
        // åˆ›å»º ID
        const id = 'cust_' + Date.now();
        
        customChords.push({
            id: id,
            name: name,
            int: intervals,
            isCustom: true
        });
        
        nameInput.value = '';
        intInput.value = '';
        
        renderChordSelectors();
        saveSettings(); // ä¿å­˜
    }

    window.removeCustomChord = function(id, event) {
        event.preventDefault();
        event.stopPropagation();
        if(!confirm("ç¡®å®šåˆ é™¤è¿™ä¸ªè‡ªå®šä¹‰å’Œå¼¦å—ï¼Ÿ")) return;
        
        customChords = customChords.filter(c => c.id !== id);
        renderChordSelectors();
        saveSettings();
    }

    // --- Tab åˆ‡æ¢ ---
    window.switchTab = function(tabId) {
        if(isPlaying) stop();
        currentTab = tabId;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        
        event.target.classList.add('active');
        document.getElementById(tabId).classList.add('active');
        updateStatus("å‡†å¤‡å°±ç»ª", "");
    };

    function setChecks(containerId, state) {
        const inputs = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
        inputs.forEach(i => i.checked = state);
    }

    function toggleChecks(containerId) {
        const inputs = document.querySelectorAll(`#${containerId} input[type="checkbox"]`);
        inputs.forEach(i => i.checked = !i.checked);
    }
    
    window.toggleAllNotes = function() {
        const notes = document.querySelectorAll('.note-check');
        const anyUnchecked = Array.from(notes).some(n => !n.classList.contains('checked'));
        notes.forEach(n => anyUnchecked ? n.classList.add('checked') : n.classList.remove('checked'));
    }

    // --- éŸ³é¢‘å¼•æ“ ---
    function initAudio() {
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if(audioCtx.state === 'suspended') audioCtx.resume();
    }

    function midiToName(midi) {
        const note = NOTE_NAMES[midi % 12];
        const oct = Math.floor(midi/12) - 1;
        return `${note}${oct}`;
    }

    function playTone(freq, start, dur, vol=0.5) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'triangle';
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        
        gain.gain.setValueAtTime(0, start);
        gain.gain.linearRampToValueAtTime(vol, start + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.001, start + dur);
        
        osc.start(start);
        osc.stop(start + dur + 0.1);
        activeOscs.push(osc);
    }

    function playNote(midi, start, dur, vol=0.5) {
        const freq = 440 * Math.pow(2, (midi-69)/12);
        playTone(freq, start, dur/1000, vol);
    }

    function speak(text) {
        if(!window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-CN';
        
        // å°è¯•åŠ è½½è¯­éŸ³ï¼ˆå¦‚æœå°šæœªåŠ è½½ï¼‰
        if(availableVoices.length === 0) loadVoices();
        
        // æŸ¥æ‰¾ä¸­æ–‡è¯­éŸ³
        const zhVoice = availableVoices.find(v => v.lang.includes('zh') || v.lang.includes('CN'));
        if (zhVoice) u.voice = zhVoice;
        
        u.rate = 1.0;
        window.speechSynthesis.speak(u);
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---

    function togglePlay() {
        if (isPlaying) {
            stop();
        } else {
            start();
        }
    }

    function start() {
        if(isPlaying) return;
        initAudio();
        isPlaying = true;
        
        // é‡ç½®é¡ºåºæ’­æ”¾çŠ¶æ€
        sequenceState = { active: false, queue: [], index: 0, data: null };
        loopRepeatState = { count: 0, max: 1, lastData: null };

        const btn = document.getElementById('btn-toggle');
        btn.innerText = "åœæ­¢ (Space)";
        btn.className = "btn btn-stop";
        
        nextRound(0);
    }

    function stop() {
        isPlaying = false;
        clearTimeout(timeoutId);
        window.speechSynthesis.cancel();
        activeOscs.forEach(o => { try{o.stop()}catch(e){} });
        activeOscs = [];
        
        const btn = document.getElementById('btn-toggle');
        btn.innerText = "å¼€å§‹è®­ç»ƒ (Space)";
        btn.className = "btn btn-start";
        
        updateStatus("å·²åœæ­¢", "");
    }

    function updateStatus(main, sub) {
        const box = document.getElementById('status-display');
        box.innerHTML = `<div class="main-text">${main}</div><div class="sub-text">${sub}</div>`;
    }

    function getValidRoot() {
        const min = parseInt(document.getElementById('range-min').value);
        const max = parseInt(document.getElementById('range-max').value);
        const allowedPCs = Array.from(document.querySelectorAll('.note-check.checked')).map(el => parseInt(el.dataset.val));
        
        if(allowedPCs.length === 0) return null;
        let pool = [];
        for(let i=min; i<=max; i++) {
            if(allowedPCs.includes(i % 12)) pool.push(i);
        }
        if(pool.length === 0) return null;
        return pool[Math.floor(Math.random() * pool.length)];
    }

    function nextRound(delay) {
        if(!isPlaying) return;
        timeoutId = setTimeout(() => {
            if(!isPlaying) return;
            switch(currentTab) {
                case 'interval-loop': logicIntervalLoop(); break;
                case 'chord-loop': logicChordLoop(); break;
                case 'interval-quiz': logicIntervalQuiz(); break;
                case 'chord-quiz': logicChordQuiz(); break;
                case 'note-quiz': logicNoteQuiz(); break;
            }
        }, delay);
    }

    // --- é€»è¾‘ 1: éŸ³ç¨‹å¾ªç¯ (ä¿®æ”¹ç‰ˆ) ---
    function logicIntervalLoop() {
        // 0. æ£€æŸ¥æ˜¯å¦å¤„äºé‡å¤çŠ¶æ€
        let root, semitones, mode, intName, note2;
        
        // å¦‚æœæ­£åœ¨é‡å¤ä¸­
        if (loopRepeatState.count < loopRepeatState.max && loopRepeatState.lastData) {
            ({ root, semitones, mode, intName, note2 } = loopRepeatState.lastData);
            loopRepeatState.count++;
        } else {
            // éœ€è¦ç”Ÿæˆæ–°çš„ (æˆ–æ¨è¿›åºåˆ—)
            
            // 1. æ£€æŸ¥æ˜¯å¦å¼€å¯äº†é¡ºåºæ’­æ”¾æ¨¡å¼
            const isSeqMode = document.getElementById('seq-mode-int').checked;
            let isNewGroup = false;

            // 2. çŠ¶æ€åˆ¤æ–­
            // å¦‚æœå¼€å¯äº†é¡ºåºæ¨¡å¼ï¼Œä¸”é˜Ÿåˆ—è¿˜æœ‰å‰©ä½™
            if (isSeqMode && sequenceState.queue.length > 0 && sequenceState.index < sequenceState.queue.length) {
                // -- ç»§ç»­æ’­æ”¾åºåˆ— --
                root = sequenceState.data.root;
                semitones = sequenceState.data.semitones;
                intName = sequenceState.data.name;
                mode = sequenceState.queue[sequenceState.index];
                sequenceState.index++; // æ­¥è¿›
                note2 = root + semitones;
            } else {
                // -- æ–°çš„ä¸€è½® --
                isNewGroup = true;
                root = getValidRoot();
                if(root === null) { alert("æ— æœ‰æ•ˆæ ¹éŸ³"); stop(); return; }

                const checkedInts = Array.from(document.querySelectorAll('#int-list-loop input:checked'));
                if(checkedInts.length === 0) { alert("è¯·é€‰æ‹©éŸ³ç¨‹"); stop(); return; }
                semitones = parseInt(checkedInts[Math.floor(Math.random()*checkedInts.length)].value);
                intName = INTERVALS.find(i => i.semitones === semitones).name;
                note2 = root + semitones;

                const dirs = Array.from(document.querySelectorAll('.play-dir-loop:checked')).map(c=>c.value);
                if(dirs.length === 0) { alert("è¯·é€‰æ‹©æ–¹å‘"); stop(); return; }

                if (isSeqMode) {
                    sequenceState.queue = dirs;
                    sequenceState.index = 0;
                    sequenceState.data = { root, semitones, name: intName };
                    
                    mode = sequenceState.queue[sequenceState.index];
                    sequenceState.index++;
                } else {
                    sequenceState.queue = [];
                    mode = dirs[Math.floor(Math.random()*dirs.length)];
                }
            }
            
            // åˆå§‹åŒ–é‡å¤çŠ¶æ€
            const repeatInput = parseInt(document.getElementById('repeat-loop-int').value) || 1;
            loopRepeatState.max = repeatInput;
            loopRepeatState.count = 1; // ç¬¬ä¸€æ¬¡æ’­æ”¾
            loopRepeatState.lastData = { root, semitones, mode, intName, note2 };
        }
        
        // 3. æ’­æ”¾é€»è¾‘ (ä¿æŒä¸å˜)
        const speed = parseInt(document.getElementById('speed-loop').value);
        const gap = parseFloat(document.getElementById('gap-loop').value) * 1000;
        const now = audioCtx.currentTime;
        let dur = 0;

        if(mode === 'asc') {
            playNote(root, now, speed);
            playNote(note2, now + speed/1000, speed);
            dur = speed * 2;
        } else if(mode === 'desc') {
            playNote(note2, now, speed);
            playNote(root, now + speed/1000, speed);
            dur = speed * 2;
        } else {
            playNote(root, now, speed*1.5);
            playNote(note2, now, speed*1.5);
            dur = speed * 1.5;
        }

        // 4. æ˜¾ç¤ºæ›´æ–°
        const isSeqMode = document.getElementById('seq-mode-int').checked;
        let seqTag = "";
        if (isSeqMode) {
            seqTag = `<span class="seq-tag">åºåˆ— ${sequenceState.index}/${sequenceState.queue.length}</span>`;
        }
        
        let repeatTag = "";
        if (loopRepeatState.max > 1) {
            repeatTag = `<span class="seq-tag" style="background:#6c5ce7">é‡å¤ ${loopRepeatState.count}/${loopRepeatState.max}</span>`;
        }

        updateStatus(`${midiToName(root)} -> ${intName} ${seqTag} ${repeatTag}`, `æ¨¡å¼: ${mode}`);
        
        nextRound(dur + gap);
    }

    // --- é€»è¾‘ 2: å’Œå¼¦å¾ªç¯ (ä¿®æ”¹ç‰ˆ) ---
    function logicChordLoop() {
        let root, chordObj, notes, mode;
        
        if (loopRepeatState.count < loopRepeatState.max && loopRepeatState.lastData) {
             ({ root, chordObj, notes, mode } = loopRepeatState.lastData);
             loopRepeatState.count++;
        } else {
            const isSeqMode = document.getElementById('seq-mode-chord').checked;
            
            // åˆ¤æ–­æ˜¯ç»§ç»­æ’­æ”¾åºåˆ—è¿˜æ˜¯ç”Ÿæˆæ–°çš„
            if (isSeqMode && sequenceState.queue.length > 0 && sequenceState.index < sequenceState.queue.length) {
                // ç»§ç»­åºåˆ—
                root = sequenceState.data.root;
                chordObj = sequenceState.data.chordObj;
                notes = sequenceState.data.notes; 
                mode = sequenceState.queue[sequenceState.index];
                sequenceState.index++;
            } else {
                // ç”Ÿæˆæ–°çš„
                root = getValidRoot();
                if(root === null) { stop(); return; }

                const checkedChords = Array.from(document.querySelectorAll('#chord-list-loop input:checked')).map(c=>c.value);
                if(checkedChords.length === 0) { alert("è¯·é€‰æ‹©å’Œå¼¦"); stop(); return; }
                
                const typeId = checkedChords[Math.floor(Math.random()*checkedChords.length)];
                chordObj = getAllChords().find(c => c.id === typeId);

                // ç”Ÿæˆ Voicing
                let rawNotes = chordObj.int.map(i => root + i);
                const allowInv = document.getElementById('inv-loop').checked;
                const allowDouble = document.getElementById('double-loop').checked;
                const maxNotes = parseInt(document.getElementById('max-notes-loop').value);
                
                if(allowDouble && Math.random() > 0.4 && rawNotes.length < maxNotes) rawNotes.push(root+12);
                if(allowInv && Math.random() > 0.5) {
                    rawNotes[0] += 12;
                    rawNotes.sort((a,b)=>a-b);
                }
                notes = rawNotes.slice(0, maxNotes);

                // ç¡®å®šæ–¹å‘
                const modes = Array.from(document.querySelectorAll('.chord-dir-loop:checked')).map(c=>c.value);
                if(modes.length === 0) { alert("è¯·é€‰æ‹©æ¨¡å¼"); stop(); return; }

                if (isSeqMode) {
                    sequenceState.queue = modes; 
                    sequenceState.index = 0;
                    sequenceState.data = { root, chordObj, notes };
                    
                    mode = sequenceState.queue[sequenceState.index];
                    sequenceState.index++;
                } else {
                    sequenceState.queue = [];
                    mode = modes[Math.floor(Math.random()*modes.length)];
                }
            }
            
            // Init Repeat
            const repeatInput = parseInt(document.getElementById('repeat-loop-chord').value) || 1;
            loopRepeatState.max = repeatInput;
            loopRepeatState.count = 1;
            loopRepeatState.lastData = { root, chordObj, notes, mode };
        }

        const speed = parseInt(document.getElementById('arp-speed-loop').value);
        const gap = parseFloat(document.getElementById('chord-gap-loop').value) * 1000;
        const now = audioCtx.currentTime;
        let dur = 0;

        if(mode === 'harmonic') {
            notes.forEach(n => playNote(n, now, 1200, 0.6/notes.length));
            dur = 1200;
        } else if (mode === 'up') {
            notes.forEach((n,i) => playNote(n, now + i*speed/1000, speed+100));
            dur = notes.length * speed + 100;
        } else {
            [...notes].reverse().forEach((n,i) => playNote(n, now + i*speed/1000, speed+100));
            dur = notes.length * speed + 100;
        }

        const isSeqMode = document.getElementById('seq-mode-chord').checked;
        let seqTag = "";
        if (isSeqMode) {
            seqTag = `<span class="seq-tag">åºåˆ— ${sequenceState.index}/${sequenceState.queue.length}</span>`;
        }
        
        let repeatTag = "";
        if (loopRepeatState.max > 1) {
            repeatTag = `<span class="seq-tag" style="background:#6c5ce7">é‡å¤ ${loopRepeatState.count}/${loopRepeatState.max}</span>`;
        }

        updateStatus(`${midiToName(root)} ${chordObj.name} ${seqTag} ${repeatTag}`, `éŸ³: ${notes.map(midiToName).join(' ')} (${mode})`);
        nextRound(dur + gap);
    }

    // --- é€»è¾‘ 3, 4, 5 (ä¿®æ”¹ç‰ˆï¼šæ”¯æŒé‡å¤æ’­æ”¾) ---
    function logicIntervalQuiz(existingData = null) {
        let root, semitones, note2, intName, mode, remainingRepeats;
        
        if (existingData) {
            ({root, semitones, note2, intName, mode, remainingRepeats} = existingData);
        } else {
            root = getValidRoot();
            if(!root) { stop(); return; }
            
            const checkedInts = Array.from(document.querySelectorAll('#int-list-quiz input:checked'));
            if(checkedInts.length === 0) { alert("é€‰éŸ³ç¨‹"); stop(); return; }
            
            semitones = parseInt(checkedInts[Math.floor(Math.random()*checkedInts.length)].value);
            note2 = root + semitones;
            intName = INTERVALS.find(i => i.semitones === semitones).name;

            mode = document.getElementById('quiz-int-mode').value;
            if(mode === 'random') mode = ['asc','desc','harm'][Math.floor(Math.random()*3)];
            
            remainingRepeats = (parseInt(document.getElementById('repeat-quiz-int').value) || 1) - 1;
        }

        const speakTextInt = intName.split(' ')[0]; 
        const speed = 500;
        const now = audioCtx.currentTime;
        let dur = 0;

        if(mode === 'asc') {
            playNote(root, now, speed);
            playNote(note2, now + speed/1000, speed);
            dur = speed * 2;
        } else if(mode === 'desc') {
            playNote(note2, now, speed);
            playNote(root, now + speed/1000, speed);
            dur = speed * 2;
        } else {
            playNote(root, now, 1000);
            playNote(note2, now, 1000);
            dur = 1000;
        }

        updateStatus("ğŸ§ å¬è¾¨ä¸­...", `ç­‰å¾…è¯­éŸ³æ­æ™“... (å‰©ä½™é‡å¤: ${remainingRepeats})`);

        if (remainingRepeats > 0) {
            // ç»§ç»­é‡å¤æ’­æ”¾é¢˜ç›®
            setTimeout(() => {
                if(!isPlaying) return;
                logicIntervalQuiz({root, semitones, note2, intName, mode, remainingRepeats: remainingRepeats - 1});
            }, dur + 600); // é—´éš”
        } else {
            // æ’­æ”¾å®Œæ¯•ï¼Œæ­æ™“ç­”æ¡ˆ
            setTimeout(() => {
                if(!isPlaying) return;
                const speakRoot = document.getElementById('speak-root-int').checked;
                const rootName = NOTE_NAMES[root % 12];
                let text = speakRoot ? `${rootName} ${speakTextInt}` : speakTextInt;
                speak(text);
                updateStatus(`ç­”æ¡ˆ: ${text}`, `(éŸ³ç¨‹: ${intName})`);
            }, dur + 500);

            const gap = parseFloat(document.getElementById('gap-quiz-int').value) * 1000;
            nextRound(dur + 1500 + gap); 
        }
    }

    function logicChordQuiz(existingData = null) {
        let root, chordObj, notes, remainingRepeats, playStyle;
        
        if (existingData) {
            ({root, chordObj, notes, remainingRepeats, playStyle} = existingData);
        } else {
            root = getValidRoot();
            if(!root) { stop(); return; }

            const checkedChords = Array.from(document.querySelectorAll('#chord-list-quiz input:checked')).map(c=>c.value);
            if(checkedChords.length === 0) { alert("é€‰å’Œå¼¦"); stop(); return; }
            
            const typeId = checkedChords[Math.floor(Math.random()*checkedChords.length)];
            chordObj = getAllChords().find(c => c.id === typeId);
            
            notes = chordObj.int.map(i => root + i);
            if(document.getElementById('inv-quiz').checked && Math.random() > 0.5) {
                notes[0] += 12;
                notes.sort((a,b)=>a-b);
            }
            
            remainingRepeats = (parseInt(document.getElementById('repeat-quiz-chord').value) || 1) - 1;
            playStyle = (Math.random() > 0.5 ? 'arp' : 'harm');
        }

        const now = audioCtx.currentTime;
        let dur = 0;
        
        if(playStyle === 'arp') {
            notes.forEach((n,i) => playNote(n, now + i*0.2, 600));
            dur = notes.length * 200 + 400;
        } else {
            notes.forEach(n => playNote(n, now, 1200, 0.6/notes.length));
            dur = 1200;
        }

        updateStatus("ğŸ§ å¬è¾¨ä¸­...", `ç­‰å¾…è¯­éŸ³æ­æ™“... (å‰©ä½™é‡å¤: ${remainingRepeats})`);

        if (remainingRepeats > 0) {
            setTimeout(() => {
                if(!isPlaying) return;
                logicChordQuiz({root, chordObj, notes, remainingRepeats: remainingRepeats - 1, playStyle});
            }, dur + 600);
        } else {
            setTimeout(() => {
                if(!isPlaying) return;
                const speakRoot = document.getElementById('speak-root-chord').checked;
                const rootName = NOTE_NAMES[root % 12];
                let cName = chordObj.name.split(' ')[0];
                let text = speakRoot ? `${rootName} ${cName}` : cName;
                speak(text);
                updateStatus(`ç­”æ¡ˆ: ${text}`, `(${chordObj.name})`);
            }, dur + 500);

            const gap = parseFloat(document.getElementById('gap-quiz-chord').value) * 1000;
            nextRound(dur + 1500 + gap);
        }
    }

    function logicNoteQuiz(existingData = null) {
        let root, durMs, remainingRepeats;
        
        if (existingData) {
            ({root, durMs, remainingRepeats} = existingData);
        } else {
            root = getValidRoot();
            if(!root) { alert("è¯·åœ¨ä¸Šæ–¹é€šç”¨è®¾ç½®ä¸­é€‰æ‹©è‡³å°‘ä¸€ä¸ªéŸ³å"); stop(); return; }
            durMs = parseInt(document.getElementById('note-dur-quiz').value);
            remainingRepeats = (parseInt(document.getElementById('repeat-quiz-note').value) || 1) - 1;
        }

        const now = audioCtx.currentTime;
        playNote(root, now, durMs);
        updateStatus("ğŸ§ å¬è¾¨ä¸­...", `... (å‰©ä½™é‡å¤: ${remainingRepeats})`);

        if (remainingRepeats > 0) {
            setTimeout(() => {
                if(!isPlaying) return;
                logicNoteQuiz({root, durMs, remainingRepeats: remainingRepeats - 1});
            }, durMs + 600);
        } else {
            setTimeout(() => {
                if(!isPlaying) return;
                let name = NOTE_NAMES[root % 12];
                if(name.includes('#')) {
                    name = name.replace('#', '') + "å‡"; 
                }
                speak(name);
                updateStatus(`ç­”æ¡ˆ: ${name}`, `(Midi: ${root})`);
            }, durMs + 300);

            const gap = parseFloat(document.getElementById('gap-quiz-note').value) * 1000;
            nextRound(durMs + 1000 + gap);
        }
    }

</script>
</body>
</html>/html>
