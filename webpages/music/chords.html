<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web å’Œå¼¦å¬åŠ›/è‰²å½©è®­ç»ƒå™¨</title>
    <style>
        :root {
            --primary-color: #6c5ce7;
            --secondary-color: #a29bfe;
            --bg-color: #f8f9fd;
            --card-bg: #ffffff;
            --text-color: #2d3436;
            --border-color: #dfe6e9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 20px;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 650px;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
            font-size: 1.8rem;
        }

        /* æ¨¡å—é€šç”¨æ ·å¼ */
        .section {
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .section-title {
            font-weight: 700;
            margin-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #555;
        }

        /* ç½‘æ ¼å¸ƒå±€ */
        .grid-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        label {
            cursor: pointer;
            display: flex;
            align-items: center;
            font-size: 0.95rem;
            user-select: none;
        }

        input[type="checkbox"] {
            accent-color: var(--primary-color);
            margin-right: 8px;
            width: 16px;
            height: 16px;
        }

        input[type="number"], input[type="text"], select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.95rem;
            width: 100%;
            box-sizing: border-box;
        }

        /* å‚æ•°è¡Œ */
        .params-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .param-item {
            flex: 1;
            min-width: 120px;
        }
        .param-label {
            display: block;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 4px;
        }

        /* çŠ¶æ€æ˜¾ç¤º */
        .status-box {
            background: #eef2f7;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-bottom: 20px;
        }
        .chord-name {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        .chord-details {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* æŒ‰é’® */
        .btn-group {
            display: flex;
            gap: 15px;
        }
        button {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-start { background-color: var(--primary-color); color: white; }
        .btn-start:hover { background-color: #5649c0; }
        .btn-stop { background-color: #ff7675; color: white; }
        .btn-stop:hover { background-color: #d63031; }
        .btn-stop:disabled { background-color: #ccc; cursor: not-allowed; }

        .helper-text { font-size: 0.8rem; color: #888; margin-top: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¹ å’Œå¼¦å¬åŠ›è®­ç»ƒå™¨</h1>

    <!-- 1. å’Œå¼¦é€‰æ‹© -->
    <div class="section">
        <div class="section-title">
            é€‰æ‹©å’Œå¼¦ç±»å‹ (å¤šé€‰)
            <button onclick="selectAllChords(true)" style="font-size:0.8rem; padding:4px 8px; width:auto; flex:none; background:#eee; color:#333;">å…¨é€‰</button>
        </div>
        <div class="grid-checkboxes" id="chord-list">
            <!-- JS ç”Ÿæˆ -->
        </div>
        <div style="margin-top: 15px;">
            <label style="font-weight:600; margin-bottom:5px;">è‡ªå®šä¹‰å’Œå¼¦ (éŸ³ç¨‹åŠéŸ³æ•°ï¼Œç©ºæ ¼åˆ†éš”)</label>
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="use-custom-chord">
                <input type="text" id="custom-chord-intervals" value="0 4 7 11 14" placeholder="ä¾‹å¦‚å¤§ä¹å’Œå¼¦: 0 4 7 11 14">
            </div>
            <div class="helper-text">å‹¾é€‰åå°†åŒ…å«è‡ªå®šä¹‰å’Œå¼¦è¿›å…¥éšæœºæ± ã€‚0=æ ¹éŸ³, 4=å¤§ä¸‰åº¦, 7=çº¯äº”åº¦ç­‰ã€‚</div>
        </div>
    </div>

    <!-- 2. æ’åˆ—ä¸èŒƒå›´è®¾ç½® -->
    <div class="section">
        <div class="section-title">æ’åˆ— (Voicing) ä¸ èŒƒå›´</div>
        <div class="params-row">
            <div class="param-item">
                <span class="param-label">æ ¹éŸ³èŒƒå›´</span>
                <div style="display:flex; align-items:center; gap:5px;">
                    <select id="range-min"></select>
                    <span>-</span>
                    <select id="range-max"></select>
                </div>
            </div>
            <div class="param-item">
                <span class="param-label">éŸ³æ•°ä¸Šé™</span>
                <input type="number" id="max-notes" value="5" min="3" max="10">
            </div>
        </div>
        <div class="grid-checkboxes" style="margin-top:10px;">
            <label><input type="checkbox" id="allow-inversion" checked> å…è®¸è½¬ä½ (Inversions)</label>
            <label><input type="checkbox" id="allow-doubling"> å…è®¸åŒçº§éŸ³é‡å¤ (Doubling)</label>
        </div>
        <div class="helper-text">
            * <b>è½¬ä½</b>ï¼šéšæœºæ”¹å˜ä½éŸ³ä½ç½®ã€‚<br>
            * <b>é‡å¤</b>ï¼šå…è®¸åœ¨ä¸åŒå…«åº¦å¢åŠ å’Œå¼¦å†…éŸ³ï¼Œä½¿ç»‡ä½“æ›´ä¸°å¯Œã€‚
        </div>
    </div>

    <!-- 3. æ¼”å¥æ¨¡å¼ -->
    <div class="section">
        <div class="section-title">æ¼”å¥æ¨¡å¼ (å¤šé€‰ï¼Œæ’­æ”¾æ—¶éšæœº)</div>
        <div class="grid-checkboxes">
            <label><input type="checkbox" name="playmode" value="up" checked> ä¸Šè¡Œç¶éŸ³ (Arp Up)</label>
            <label><input type="checkbox" name="playmode" value="down"> ä¸‹è¡Œç¶éŸ³ (Arp Down)</label>
            <label><input type="checkbox" name="playmode" value="harmonic" checked> æŸ±å¼å’Œå¼¦ (Harmonic)</label>
        </div>
    </div>

    <!-- 4. é€Ÿåº¦æ§åˆ¶ -->
    <div class="section" style="border-bottom:none;">
        <div class="section-title">é€Ÿåº¦è®¾ç½®</div>
        <div class="params-row">
            <div class="param-item">
                <span class="param-label">ç¶éŸ³å•éŸ³æ—¶é•¿ (ms)</span>
                <input type="number" id="note-speed" value="150" min="50" max="1000" step="10">
            </div>
            <div class="param-item">
                <span class="param-label">å’Œå¼¦ä¿æŒæ—¶é•¿ (ms)</span>
                <input type="number" id="chord-sustain" value="1200" min="500" max="5000" step="100">
            </div>
            <div class="param-item">
                <span class="param-label">ç»„é—´é—´éš” (ç§’)</span>
                <input type="number" id="group-gap" value="2" min="0.5" max="10" step="0.5">
            </div>
        </div>
    </div>

    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div class="status-box" id="status-box">
        <div style="color:#999;">ç‚¹å‡»å¼€å§‹è¿›è¡Œè®­ç»ƒ</div>
    </div>

    <div class="btn-group">
        <button class="btn-start" id="btn-start">å¼€å§‹è®­ç»ƒ</button>
        <button class="btn-stop" id="btn-stop" disabled>åœæ­¢</button>
    </div>
</div>

<script>
    // --- æ•°æ®å®šä¹‰ ---
    const CHORD_TYPES = [
        { id: 'maj', name: 'å¤§ä¸‰å’Œå¼¦ (Major)', intervals: [0, 4, 7] },
        { id: 'min', name: 'å°ä¸‰å’Œå¼¦ (Minor)', intervals: [0, 3, 7] },
        { id: 'aug', name: 'å¢ä¸‰å’Œå¼¦ (Aug)', intervals: [0, 4, 8] },
        { id: 'dim', name: 'å‡ä¸‰å’Œå¼¦ (Dim)', intervals: [0, 3, 6] },
        { id: 'sus4', name: 'æŒ‚å››å’Œå¼¦ (Sus4)', intervals: [0, 5, 7] },
        { id: 'maj7', name: 'å¤§ä¸ƒå’Œå¼¦ (Maj7)', intervals: [0, 4, 7, 11] },
        { id: 'min7', name: 'å°ä¸ƒå’Œå¼¦ (Min7)', intervals: [0, 3, 7, 10] },
        { id: 'dom7', name: 'å±ä¸ƒå’Œå¼¦ (Dom7)', intervals: [0, 4, 7, 10] },
        { id: 'm7b5', name: 'åŠå‡ä¸ƒ (Half Dim)', intervals: [0, 3, 6, 10] },
        { id: 'dim7', name: 'å‡ä¸ƒå’Œå¼¦ (Dim7)', intervals: [0, 3, 6, 9] },
        { id: 'maj9', name: 'å¤§ä¹å’Œå¼¦ (Maj9)', intervals: [0, 4, 7, 11, 14] },
        { id: 'min9', name: 'å°ä¹å’Œå¼¦ (Min9)', intervals: [0, 3, 7, 10, 14] },
    ];

    const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    let audioCtx;
    let isPlaying = false;
    let timeoutIds = []; // å­˜å‚¨æ‰€æœ‰å®šæ—¶å™¨IDä»¥ä¾¿åœæ­¢
    let activeOscillators = []; // å­˜å‚¨æ‰€æœ‰æŒ¯è¡å™¨ä»¥ä¾¿åœæ­¢

    // --- åˆå§‹åŒ– UI ---
    window.onload = () => {
        initChordCheckboxes();
        initRangeSelectors();
    };

    function initChordCheckboxes() {
        const container = document.getElementById('chord-list');
        CHORD_TYPES.forEach(chord => {
            const div = document.createElement('div');
            // é»˜è®¤é€‰ä¸­ å¤§ä¸‰ã€å°ä¸‰
            const checked = ['maj', 'min', 'maj7'].includes(chord.id) ? 'checked' : '';
            div.innerHTML = `<label><input type="checkbox" name="chord-type" value="${chord.id}" ${checked}> ${chord.name}</label>`;
            container.appendChild(div);
        });
    }

    function selectAllChords(select) {
        document.querySelectorAll('input[name="chord-type"]').forEach(cb => cb.checked = select);
    }

    function initRangeSelectors() {
        const minSel = document.getElementById('range-min');
        const maxSel = document.getElementById('range-max');
        for (let i = 36; i <= 72; i++) { // C2 - C5
            const label = getNoteName(i);
            minSel.add(new Option(label, i));
            maxSel.add(new Option(label, i));
        }
        minSel.value = 48; // C3
        maxSel.value = 60; // C4
    }

    // --- éŸ³é¢‘å¼•æ“ ---

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function midiToFreq(midi) {
        return 440 * Math.pow(2, (midi - 69) / 12);
    }

    function getNoteName(midi) {
        return noteNames[midi % 12] + (Math.floor(midi/12)-1);
    }

    // æ’­æ”¾å•ä¸ªéŸ³
    function playTone(midi, startTime, durationMs, volume = 0.3) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = 'triangle'; // ä¸‰è§’æ³¢é€‚åˆå’Œå¼¦ï¼Œæ¯”æ­£å¼¦æ³¢ä¸°å¯Œ
        osc.frequency.value = midiToFreq(midi);

        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = startTime;
        const dur = durationMs / 1000;

        // åŒ…ç»œ
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(volume, now + 0.02);
        gain.gain.exponentialRampToValueAtTime(0.001, now + dur);

        osc.start(now);
        osc.stop(now + dur + 0.1);

        activeOscillators.push(osc);
        // æ¸…ç†å¼•ç”¨
        osc.onended = () => {
            const idx = activeOscillators.indexOf(osc);
            if (idx > -1) activeOscillators.splice(idx, 1);
        };
    }

    // --- æ ¸å¿ƒé€»è¾‘ ---

    function startTraining() {
        if (isPlaying) return;

        // éªŒè¯é€‰æ‹©
        const selectedChords = Array.from(document.querySelectorAll('input[name="chord-type"]:checked')).map(cb => cb.value);
        const useCustom = document.getElementById('use-custom-chord').checked;
        const playModes = Array.from(document.querySelectorAll('input[name="playmode"]:checked')).map(cb => cb.value);

        if (selectedChords.length === 0 && !useCustom) {
            alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ç§å’Œå¼¦ç±»å‹ï¼");
            return;
        }
        if (playModes.length === 0) {
            alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ç§æ¼”å¥æ¨¡å¼ï¼");
            return;
        }

        initAudio();
        isPlaying = true;
        updateUIState(true);
        scheduleNextChord(0);
    }

    function stopTraining() {
        isPlaying = false;
        // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
        timeoutIds.forEach(id => clearTimeout(id));
        timeoutIds = [];
        // åœæ­¢æ‰€æœ‰å‘å£°
        activeOscillators.forEach(osc => {
            try { osc.stop(); } catch(e){}
        });
        activeOscillators = [];
        
        updateUIState(false);
        document.getElementById('status-box').innerHTML = '<div style="color:#999;">å·²åœæ­¢</div>';
    }

    function updateUIState(active) {
        document.getElementById('btn-start').disabled = active;
        document.getElementById('btn-stop').disabled = !active;
    }

    // è·å–å½“å‰åˆæ³•çš„å’Œå¼¦å®šä¹‰åˆ—è¡¨
    function getAvailableChords() {
        let pool = [];
        const checkedTypes = Array.from(document.querySelectorAll('input[name="chord-type"]:checked')).map(cb => cb.value);
        
        CHORD_TYPES.forEach(c => {
            if (checkedTypes.includes(c.id)) pool.push(c);
        });

        if (document.getElementById('use-custom-chord').checked) {
            const raw = document.getElementById('custom-chord-intervals').value.trim();
            const ints = raw.split(/\s+/).map(n => parseInt(n)).filter(n => !isNaN(n));
            if (ints.length > 0) {
                pool.push({ name: 'è‡ªå®šä¹‰å’Œå¼¦', intervals: ints });
            }
        }
        return pool;
    }

    // ç”Ÿæˆå…·ä½“çš„éŸ³ç¬¦æ•°ç»„ (Voicing)
    function generateVoicing(rootMidi, intervals) {
        let notes = intervals.map(i => rootMidi + i);
        
        const allowInversion = document.getElementById('allow-inversion').checked;
        const allowDoubling = document.getElementById('allow-doubling').checked;
        const maxNotes = parseInt(document.getElementById('max-notes').value);

        // 1. åŒçº§éŸ³é‡å¤ (Doubling)
        // ç­–ç•¥ï¼šéšæœºæŒ‘é€‰å‡ ä¸ªç°æœ‰çš„éŸ³ï¼Œå‘ä¸Šæˆ–å‘ä¸‹å…«åº¦å¤åˆ¶
        if (allowDoubling) {
            const doublingChance = 0.6;
            // å°è¯•å¢åŠ  1-2 ä¸ªéŸ³
            let attempts = 0;
            while (notes.length < maxNotes && attempts < 3) {
                if (Math.random() < doublingChance) {
                    const srcNote = notes[Math.floor(Math.random() * notes.length)];
                    const newNote = srcNote + 12; // å‘ä¸Šå…«åº¦
                    if (!notes.includes(newNote) && newNote < 96) { // é™åˆ¶ä¸è¿‡é«˜
                        notes.push(newNote);
                    }
                }
                attempts++;
            }
        }

        // 2. è½¬ä½ (Inversion)
        // ç®€å•çš„è½¬ä½é€»è¾‘ï¼šéšæœºé€‰æ‹©ä½éŸ³æ˜¯å¦å‘ä¸Šå…«åº¦ç¿»è½¬
        if (allowInversion) {
            // 50% æ¦‚ç‡è¿›è¡ŒæŸç§è½¬ä½æ“ä½œ
            if (Math.random() > 0.4) {
                // æ–¹å¼ï¼šå°†æœ€ä½çš„éŸ³ +12ï¼Œé‡å¤æ­¤è¿‡ç¨‹ 0-2 æ¬¡
                const inversions = Math.floor(Math.random() * 3); // 0, 1, 2æ¬¡è½¬ä½
                for (let k = 0; k < inversions; k++) {
                    notes.sort((a,b) => a-b); // ç¡®ä¿æœ‰åº
                    const low = notes.shift(); // æ‹¿å‡ºæœ€ä½éŸ³
                    notes.push(low + 12); // æ”¾åˆ°é«˜å…«åº¦
                }
            }
        }

        // 3. æˆªæ–­ä¸æ’åº
        notes = notes.slice(0, maxNotes);
        notes.sort((a,b) => a-b);
        return notes;
    }

    function scheduleNextChord(delayMs) {
        if (!isPlaying) return;
        const tid = setTimeout(playChordEvent, delayMs);
        timeoutIds.push(tid);
    }

    function playChordEvent() {
        if (!isPlaying) return;

        // 1. å‚æ•°è·å–
        const availableChords = getAvailableChords();
        if (availableChords.length === 0) { stopTraining(); return; }

        const minRoot = parseInt(document.getElementById('range-min').value);
        const maxRoot = parseInt(document.getElementById('range-max').value);
        const playModes = Array.from(document.querySelectorAll('input[name="playmode"]:checked')).map(cb => cb.value);

        const noteSpeed = parseInt(document.getElementById('note-speed').value);
        const chordSustain = parseInt(document.getElementById('chord-sustain').value);
        const groupGap = parseFloat(document.getElementById('group-gap').value) * 1000;

        // 2. éšæœºç”Ÿæˆ
        const targetChord = availableChords[Math.floor(Math.random() * availableChords.length)];
        const rootMidi = Math.floor(Math.random() * (maxRoot - minRoot + 1)) + minRoot;
        const mode = playModes[Math.floor(Math.random() * playModes.length)];

        // 3. ç”Ÿæˆ Voicing
        const notes = generateVoicing(rootMidi, targetChord.intervals);

        // 4. æ’­æ”¾é€»è¾‘
        const now = audioCtx.currentTime;
        let totalPlayTime = 0;
        let displayMode = "";

        if (mode === 'harmonic') {
            // æŸ±å¼å’Œå¼¦ï¼šåŒæ—¶æ’­æ”¾
            // æ³¨æ„ï¼šå¤šéŸ³å¹¶å‘éŸ³é‡è¦å‡å°
            const vol = 0.6 / notes.length; 
            notes.forEach(n => playTone(n, now, chordSustain, vol));
            totalPlayTime = chordSustain;
            displayMode = "æŸ±å¼å’Œå¼¦";
        } else if (mode === 'up') {
            // ä¸Šè¡Œ
            notes.forEach((n, idx) => {
                playTone(n, now + idx * (noteSpeed/1000), noteSpeed + 200, 0.4);
            });
            totalPlayTime = notes.length * noteSpeed + 200;
            displayMode = "ä¸Šè¡Œç¶éŸ³";
        } else if (mode === 'down') {
            // ä¸‹è¡Œ
            const revNotes = [...notes].reverse();
            revNotes.forEach((n, idx) => {
                playTone(n, now + idx * (noteSpeed/1000), noteSpeed + 200, 0.4);
            });
            totalPlayTime = notes.length * noteSpeed + 200;
            displayMode = "ä¸‹è¡Œç¶éŸ³";
        }

        // 5. æ›´æ–° UI
        const rootName = getNoteName(rootMidi);
        const notesText = notes.map(n => getNoteName(n)).join("-");
        
        document.getElementById('status-box').innerHTML = `
            <div class="chord-name">${rootName} ${targetChord.name}</div>
            <div class="chord-details">
                æ¨¡å¼: ${displayMode} | éŸ³ç¬¦: [${notesText}]
            </div>
        `;

        // 6. ä¸‹ä¸€ç»„
        scheduleNextChord(totalPlayTime + groupGap);
    }

    // äº‹ä»¶ç»‘å®š
    document.getElementById('btn-start').addEventListener('click', startTraining);
    document.getElementById('btn-stop').addEventListener('click', stopTraining);

</script>
</body>
</html>
