<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web éŸ³ç¨‹å¬åŠ›è®­ç»ƒå™¨ (V3)</title>
    <style>
        :root {
            --primary-color: #4a90e2;
            --bg-color: #f4f4f9;
            --card-bg: #ffffff;
            --text-color: #333;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 500px;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .control-group {
            margin-bottom: 1.2rem;
            border-bottom: 1px solid #eee;
            padding-bottom: 1rem;
        }

        .control-group:last-child {
            border-bottom: none;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        select, input[type="number"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1rem;
        }

        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-label input {
            margin-right: 6px;
            width: auto;
        }

        .range-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .param-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .param-row span {
            flex-shrink: 0;
            margin-right: 10px;
            font-size: 0.95rem;
        }
        .param-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .param-input-group input {
             width: 80px;
             text-align: center;
        }

        .btn-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: 600;
        }

        #btn-start { background-color: var(--primary-color); color: white; }
        #btn-start:hover { background-color: #357abd; }
        #btn-stop { background-color: #e74c3c; color: white; }
        #btn-stop:hover { background-color: #c0392b; }
        #btn-stop:disabled { background-color: #e0e0e0; color: #999; cursor: not-allowed; }

        .status-display {
            margin-top: 15px;
            padding: 10px;
            background: #eef2f7;
            border-radius: 4px;
            text-align: center;
            min-height: 24px;
            font-size: 0.9rem;
            color: #555;
            line-height: 1.4;
        }

        .highlight { color: var(--primary-color); font-weight: bold; }
        .sub-text { font-size: 0.8rem; color: #777; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸµ éšæœºéŸ³ç¨‹ç”Ÿæˆå™¨ (V3)</h1>

    <!-- 1. éŸ³ç¨‹é€‰æ‹© -->
    <div class="control-group">
        <label for="interval-select">é€‰æ‹©éŸ³ç¨‹</label>
        <select id="interval-select">
            <option value="1">å°äºŒåº¦ (Minor 2nd)</option>
            <option value="2">å¤§äºŒåº¦ (Major 2nd)</option>
            <option value="3">å°ä¸‰åº¦ (Minor 3rd)</option>
            <option value="4" selected>å¤§ä¸‰åº¦ (Major 3rd)</option>
            <option value="5">çº¯å››åº¦ (Perfect 4th)</option>
            <option value="6">ä¸‰å…¨éŸ³ (Tritone)</option>
            <option value="7">çº¯äº”åº¦ (Perfect 5th)</option>
            <option value="8">å°å…­åº¦ (Minor 6th)</option>
            <option value="9">å¤§å…­åº¦ (Major 6th)</option>
            <option value="10">å°ä¸ƒåº¦ (Minor 7th)</option>
            <option value="11">å¤§ä¸ƒåº¦ (Major 7th)</option>
            <option value="12">çº¯å…«åº¦ (Octave)</option>
        </select>
    </div>

    <!-- 2. æ ¹éŸ³èŒƒå›´ -->
    <div class="control-group">
        <label>æ ¹éŸ³èŒƒå›´ (MIDIéŸ³é«˜)</label>
        <div class="range-inputs">
            <select id="range-min"></select>
            <span>è‡³</span>
            <select id="range-max"></select>
        </div>
        <small style="color:#666; display:block; margin-top:5px;">C4 (ä¸­å¤®C) = 60</small>
    </div>

    <!-- 3. æ’­æ”¾æ¨¡å¼ -->
    <div class="control-group">
        <label>æ’­æ”¾æ–¹å‘ (å¯å¤šé€‰)</label>
        <div class="checkbox-group">
            <label class="checkbox-label"><input type="checkbox" id="dir-asc" checked> ä¸Šè¡Œ</label>
            <label class="checkbox-label"><input type="checkbox" id="dir-desc" checked> ä¸‹è¡Œ</label>
            <label class="checkbox-label"><input type="checkbox" id="dir-harm" checked> å’Œå£°</label>
        </div>
        <div class="checkbox-group" style="margin-top: 12px; padding-top:10px; border-top:1px dashed #ddd; width:100%;">
            <label class="checkbox-label" title="å‹¾é€‰åï¼ŒåŒä¸€ç»„éŸ³ä¼šæŒ‰é€‰ä¸­é¡ºåºä¾æ¬¡æ’­æ”¾(å¦‚å…ˆä¸Šè¡Œï¼Œå†ä¸‹è¡Œï¼Œè¿˜æ˜¯è¿™ä¿©éŸ³)">
                <input type="checkbox" id="play-in-order" checked> 
                <strong>é¡ºåºæ’­æ”¾ä¸”éŸ³ç»„é”å®š</strong>
            </label>
        </div>
    </div>

    <!-- 4. é€Ÿåº¦ä¸é—´éš” -->
    <div class="control-group">
        <label>å‚æ•°è®¾ç½®</label>
        <div style="display:flex; flex-direction:column;">
            <div class="param-row">
                <span>å•éŸ³æ—¶é•¿ (é€Ÿåº¦)</span>
                <div class="param-input-group"><input type="number" id="note-duration" value="500" min="100" max="2000" step="50"> ms</div>
            </div>
             <div class="param-row">
                <span>éŸ³é—´é—´éš” (ä¸Šä¸‹è¡Œ)</span>
                <div class="param-input-group"><input type="number" id="note-gap" value="0" min="0" max="1000" step="10"> ms</div>
            </div>
            <div class="param-row">
                <span>ç»„é—´é—´éš”</span>
                <div class="param-input-group"><input type="number" id="group-gap" value="2.0" min="0.5" max="10" step="0.5"> ç§’</div>
            </div>
        </div>
    </div>

    <div class="status-display" id="status-display">å‡†å¤‡å°±ç»ª</div>

    <div class="btn-container">
        <button id="btn-start">å¼€å§‹ç»ƒä¹ </button>
        <button id="btn-stop" disabled>åœæ­¢</button>
    </div>
</div>

<script>
    // --- éŸ³é¢‘ä¸Šä¸‹æ–‡ä¸å…¨å±€å˜é‡ ---
    let audioCtx;
    let isPlaying = false;
    let timeoutId = null;
    
    // -- çŠ¶æ€æ§åˆ¶ --
    let directionSequence = []; // å­˜å‚¨ç”¨æˆ·å‹¾é€‰çš„æ¨¡å¼åºåˆ— ['asc', 'desc', 'harm']
    let directionSequenceIndex = 0; // å½“å‰æ’­æ”¾åˆ°åºåˆ—çš„ç¬¬å‡ æ­¥
    let currentRootMidi = null; // å½“å‰é”å®šçš„æ ¹éŸ³

    const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    
    // --- åˆå§‹åŒ– UI ---
    window.onload = function() {
        populateRangeSelectors();
    };

    function populateRangeSelectors() {
        const minSel = document.getElementById('range-min');
        const maxSel = document.getElementById('range-max');
        for (let i = 36; i <= 84; i++) { // C2 to C6
            const octave = Math.floor(i / 12) - 1;
            const noteName = noteNames[i % 12];
            const label = `${noteName}${octave} (${i})`;
            [minSel, maxSel].forEach(sel => sel.add(new Option(label, i)));
        }
        minSel.value = 48; // C3
        maxSel.value = 72; // C5
    }

    // --- éŸ³é¢‘é€»è¾‘ ---
    function midiToFreq(midi) {
        return 440 * Math.pow(2, (midi - 69) / 12);
    }

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        if (audioCtx.state === 'suspended') {
            audioCtx.resume();
        }
    }

    function playTone(freq, startTime, durationMs) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = 'triangle';
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = startTime;
        const dur = durationMs / 1000;
        
        // å¢ç›ŠåŒ…ç»œï¼šéŸ³é‡0.8
        gain.gain.setValueAtTime(0, now);
        gain.gain.linearRampToValueAtTime(0.8, now + 0.02); 
        gain.gain.exponentialRampToValueAtTime(0.001, now + dur); 

        osc.start(now);
        osc.stop(now + dur);
    }

    // --- æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ---

    function startTraining() {
        if (isPlaying) return;
        
        // æ„å»ºæ’­æ”¾åˆ—è¡¨
        directionSequence = [];
        if (document.getElementById('dir-asc').checked) directionSequence.push('asc');
        if (document.getElementById('dir-desc').checked) directionSequence.push('desc');
        if (document.getElementById('dir-harm').checked) directionSequence.push('harm');

        if (directionSequence.length === 0) {
            alert("è¯·è‡³å°‘é€‰æ‹©ä¸€ç§æ’­æ”¾æ–¹å‘ï¼ˆä¸Šè¡Œã€ä¸‹è¡Œæˆ–å’Œå£°ï¼‰ã€‚");
            return;
        }

        // é‡ç½®çŠ¶æ€
        directionSequenceIndex = 0; 
        currentRootMidi = null; // ç¡®ä¿ç¬¬ä¸€æ¬¡å¼€å§‹æ—¶é‡æ–°ç”Ÿæˆ

        initAudio();
        isPlaying = true;
        updateUIState(true);
        document.getElementById('status-display').textContent = "è®­ç»ƒå¼€å§‹...";
        
        scheduleNextGroup(0);
    }

    function stopTraining() {
        isPlaying = false;
        clearTimeout(timeoutId);
        updateUIState(false);
        document.getElementById('status-display').textContent = "å·²åœæ­¢";
    }

    function updateUIState(active) {
        document.getElementById('btn-start').disabled = active;
        document.getElementById('btn-stop').disabled = !active;
    }

    function scheduleNextGroup(delayMs) {
        if (!isPlaying) return;
        timeoutId = setTimeout(playNextInterval, delayMs);
    }

    // ç”Ÿæˆéšæœºæ ¹éŸ³çš„è¾…åŠ©å‡½æ•°
    function generateRandomRoot() {
        const minRoot = parseInt(document.getElementById('range-min').value);
        const maxRoot = parseInt(document.getElementById('range-max').value);
        const actualMin = Math.min(minRoot, maxRoot);
        const actualMax = Math.max(minRoot, maxRoot);
        return Math.floor(Math.random() * (actualMax - actualMin + 1)) + actualMin;
    }

    function playNextInterval() {
        if (!isPlaying) return;

        // 1. è·å–åŸºç¡€å‚æ•°
        const intervalSize = parseInt(document.getElementById('interval-select').value);
        const noteDuration = parseInt(document.getElementById('note-duration').value);
        const groupGap = parseFloat(document.getElementById('group-gap').value);
        const noteGap = parseInt(document.getElementById('note-gap').value); 
        const playInOrder = document.getElementById('play-in-order').checked; 

        // 2. ç¡®å®šæ ¹éŸ³å’Œæ’­æ”¾æ¨¡å¼
        let rootMidi;
        let mode;
        let isNewGroup = false; // ç”¨äºUIæ˜¾ç¤ºæ˜¯å¦æ˜¯æ–°çš„ä¸€ç»„

        if (playInOrder) {
            // --- é¡ºåºæ’­æ”¾é€»è¾‘ ---
            
            // å¦‚æœæ˜¯åºåˆ—çš„å¼€å§‹ï¼ˆindexä¸º0ï¼‰ï¼Œæˆ–è€…ä¹‹å‰æ²¡æœ‰æ ¹éŸ³ï¼Œåˆ™ç”Ÿæˆæ–°çš„
            if (directionSequenceIndex === 0 || currentRootMidi === null) {
                currentRootMidi = generateRandomRoot();
                isNewGroup = true;
            }
            
            rootMidi = currentRootMidi; // ä½¿ç”¨é”å®šçš„æ ¹éŸ³
            mode = directionSequence[directionSequenceIndex];
            
            // æ¨è¿›ç´¢å¼•ï¼Œå¦‚æœåˆ°å¤´äº†å°±å›åˆ°0
            directionSequenceIndex = (directionSequenceIndex + 1) % directionSequence.length;
            
        } else {
            // --- éšæœºæ’­æ”¾é€»è¾‘ ---
            rootMidi = generateRandomRoot();
            mode = directionSequence[Math.floor(Math.random() * directionSequence.length)];
            isNewGroup = true;
        }

        const secondMidi = rootMidi + intervalSize;

        // 3. æ’­æ”¾éŸ³é¢‘
        const now = audioCtx.currentTime;
        const rootFreq = midiToFreq(rootMidi);
        const secondFreq = midiToFreq(secondMidi);

        let statusText = "";
        let playTime = 0;
        
        const noteDurationSec = noteDuration / 1000;
        const noteGapSec = noteGap / 1000; 

        if (mode === 'asc') {
            playTone(rootFreq, now, noteDuration);
            playTone(secondFreq, now + noteDurationSec + noteGapSec, noteDuration);
            playTime = (noteDuration * 2) + noteGap;
            statusText = "ä¸Šè¡Œ";
        } else if (mode === 'desc') {
            playTone(secondFreq, now, noteDuration);
            playTone(rootFreq, now + noteDurationSec + noteGapSec, noteDuration);
            playTime = (noteDuration * 2) + noteGap;
            statusText = "ä¸‹è¡Œ";
        } else { // harm
            const harmonicDuration = noteDuration * 1.5;
            playTone(rootFreq, now, harmonicDuration);
            playTone(secondFreq, now, harmonicDuration);
            playTime = harmonicDuration;
            statusText = "å’Œå£°";
        }
        
        // 4. æ›´æ–° UI
        const rootName = noteNames[rootMidi % 12] + (Math.floor(rootMidi/12)-1);
        const rootInfo = `<br><span class="sub-text">æ ¹éŸ³: ${rootName}</span>`;
        
        if (playInOrder) {
            // è®¡ç®—è¿™æ˜¯ç¬¬å‡ æ­¥
            // å½“å‰åˆšåˆšæ’­æ”¾å®Œçš„ç´¢å¼•æ˜¯ (directionSequenceIndex - 1)ï¼Œå› ä¸ºä¸Šé¢å·²ç»+1äº†
            // å¦‚æœå‡å®Œæ˜¯-1 (è¯´æ˜ä¹‹å‰æ˜¯0ï¼Œç°åœ¨å˜æˆäº†1)ï¼Œä¿®æ­£é€»è¾‘å…¶å®æ˜¯ï¼š
            // å¦‚æœ index å˜æˆäº† 0ï¼Œè¯´æ˜åˆšåˆšæ’­æ”¾çš„æ˜¯æœ€åä¸€ä¸ªã€‚
            let currentStep = directionSequenceIndex === 0 ? directionSequence.length : directionSequenceIndex;
            let totalSteps = directionSequence.length;
            
            document.getElementById('status-display').innerHTML = 
                `<span class="highlight">${statusText}</span> (åºåˆ— ${currentStep}/${totalSteps})` + rootInfo;
        } else {
            document.getElementById('status-display').innerHTML = 
                `<span class="highlight">${statusText}</span> (éšæœº)` + rootInfo;
        }

        // 5. è®¡åˆ’ä¸‹ä¸€ç»„
        // å¦‚æœæ˜¯é¡ºåºæ’­æ”¾ï¼Œä¸”è¿˜æ²¡è·‘å®Œä¸€è½®åºåˆ—ï¼Œé—´éš”å¯ä»¥ç¨å¾®çŸ­ä¸€ç‚¹(å¯é€‰)ï¼Œ
        // è¿™é‡Œä¸ºäº†ç®€å•ç»Ÿä¸€ä½¿ç”¨ groupGap
        const totalWait = playTime + (groupGap * 1000);
        scheduleNextGroup(totalWait);
    }

    // --- äº‹ä»¶ç»‘å®š ---
    document.getElementById('btn-start').addEventListener('click', startTraining);
    document.getElementById('btn-stop').addEventListener('click', stopTraining);

</script>

</body>
</html>
